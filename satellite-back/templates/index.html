<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Satellitensteuerung</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <header class="header">
      <h1>Satellitensteuerung</h1>
      <span id="conn" class="badge">Idle</span>
    </header>

    <div id="error" class="error hidden"></div>

    <section class="card">
      <h2>Status</h2>
      <div class="status-grid">
        <div>
          <h3>Ziel (Sat)</h3>
          <p>Azimut: <strong id="sat-az">–</strong></p>
          <p>Elevation: <strong id="sat-el">–</strong></p>
        </div>
        <div>
          <h3>Antenne (Ist)</h3>
          <p>Azimut: <strong id="ant-az">–</strong></p>
          <p>Elevation: <strong id="ant-el">–</strong></p>
        </div>
      </div>
      <p>Sichtbar noch: <strong id="visibility">–</strong></p>
      <p>Signal: <strong id="sig">–</strong></p>
      <div class="bar"><div id="sigbar" class="bar-fill" style="width:0%"></div></div>
    </section>

    <section class="card">
      <h2>Betriebsmodus</h2>
      <select id="mode">
        <option value="geo">Automatik – geostationär</option>
        <option value="polar">Automatik – polumlaufend</option>
        <option value="manual">Manuell</option>
      </select>
    </section>

    <section class="card">
      <h2>Satellit</h2>
      <select id="satellite"></select>
      <p class="hint">Aktuelle ID: <strong id="sat-label">–</strong></p>
    </section>

    <section class="card">
      <h2>Manuelle Steuerung</h2>
      <div class="pad">
        <div></div>
        <button data-dir="up">&uarr;</button>
        <div></div>
        <button data-dir="left">&larr;</button>
        <div></div>
        <button data-dir="right">&rarr;</button>
        <div></div>
        <button data-dir="down">&darr;</button>
        <div></div>
      </div>
    </section>
  </main>

  <script>
    const modeEl = document.getElementById('mode');
    const satEl = document.getElementById('satellite');
    const satLabel = document.getElementById('sat-label');
    const errEl = document.getElementById('error');
    const connEl = document.getElementById('conn');
    const satAzEl = document.getElementById('sat-az');
    const satElEl = document.getElementById('sat-el');
    const antAzEl = document.getElementById('ant-az');
    const antElEl = document.getElementById('ant-el');
    const visibilityEl = document.getElementById('visibility');
    const sigEl = document.getElementById('sig');
    const sigBar = document.getElementById('sigbar');
    const padButtons = document.querySelectorAll('.pad button');
    let satellites = [];

    function showError(msg) {
      errEl.textContent = msg;
      errEl.classList.remove('hidden');
    }
    function clearError() {
      errEl.textContent = '';
      errEl.classList.add('hidden');
    }

    async function fetchStatus() {
      try {
        connEl.textContent = 'Lädt…';
        connEl.className = 'badge warn';
        const res = await fetch('/api/status');
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        satAzEl.textContent = data.position.azimuth?.toFixed(1) + '°';
        satElEl.textContent = data.position.elevation?.toFixed(1) + '°';
        const antAz = data.antenna?.azimuth;
        const antEl = data.antenna?.elevation;
        antAzEl.textContent = antAz !== undefined && antAz !== null ? `${antAz.toFixed(1)}°` : '–';
        antElEl.textContent = antEl !== undefined && antEl !== null ? `${antEl.toFixed(1)}°` : '–';
        const vis = data.visibility_seconds;
        if (vis === null || vis === undefined) {
          visibilityEl.textContent = '–';
        } else {
          const minutes = Math.max(0, Math.round(vis / 60));
          visibilityEl.textContent = `${minutes} min`;
        }
        sigEl.textContent = (data.signal ?? '–') + '%';
        sigBar.style.width = `${data.signal ?? 0}%`;
        modeEl.value = data.mode;
        satEl.value = data.satellite_id;
        satLabel.textContent = data.satellite_id;
        connEl.textContent = 'Verbunden';
        connEl.className = 'badge ok';
        clearError();
        // Versuche, Dropdown an die aktuelle ID anzupassen, falls geladen
        if (satEl.options.length > 0 && data.satellite_id) {
          satEl.value = data.satellite_id;
        }
      } catch (err) {
        connEl.textContent = 'Fehler';
        connEl.className = 'badge err';
        showError(err.message || 'Status konnte nicht geladen werden');
      }
    }

    modeEl.addEventListener('change', async (e) => {
      try {
        await fetch('/api/mode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: e.target.value })
        });
      } catch (err) {
        showError(err.message || 'Modus-Update fehlgeschlagen');
      }
    });

    satEl.addEventListener('change', async (e) => {
      try {
        const id = Number(e.target.value);
        await fetch('/api/target', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ satellite_id: id })
        });
        satLabel.textContent = id;
      } catch (err) {
        showError(err.message || 'Satellit konnte nicht gesetzt werden');
      }
    });

    padButtons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        try {
          const dir = btn.dataset.dir;
          await fetch('/api/manual', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: dir })
          });
        } catch (err) {
          showError(err.message || 'Befehl konnte nicht gesendet werden');
        }
      });
    });

    async function loadSatellites() {
      try {
        const res = await fetch('/api/above');
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        satellites = data.above ?? [];
        satEl.innerHTML = '';
        satellites.forEach((sat) => {
          const id = sat.satid || sat.id;
          const name = sat.satname || sat.name || 'Sat';
          const opt = document.createElement('option');
          opt.value = id;
          opt.textContent = `${name} (ID ${id})`;
          satEl.appendChild(opt);
        });
        if (satellites.length === 0) {
          const opt = document.createElement('option');
          opt.textContent = 'Keine Satelliten gefunden';
          satEl.appendChild(opt);
        }
      } catch (err) {
        showError(err.message || 'Satelliten konnten nicht geladen werden');
      }
    }

    loadSatellites();
    fetchStatus();
    setInterval(fetchStatus, 5000);
  </script>
</body>
</html>
